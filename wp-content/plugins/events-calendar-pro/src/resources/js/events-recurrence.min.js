var tribe_events_pro_admin=tribe_events_pro_admin||{};tribe_events_pro_admin.recurrence={recurrence_count:0,exclusion_count:0,event:{}},function(r,t){"use strict";t.init=function(){this.init_recurrence()},t.init_recurrence=function(){this.$recurrence_staging=r("#tribe-recurrence-staging"),this.$recurrence_tmpl=r("#tmpl-tribe-recurrence"),this.$recurrence_tmpl.length&&(this.recurrence_template=Handlebars.compile(this.$recurrence_tmpl.html()),this.$add_recurrence=r("#tribe-add-recurrence"),this.$recurrence_rules=r(".tribe-event-recurrence-rule"),this.$exclusion_staging=r("#tribe-exclusion-staging"),this.$exclusion_tmpl=r("#tmpl-tribe-exclusion"),this.exclusion_template=Handlebars.compile(this.$exclusion_tmpl.html()),this.$add_exclusion=r("#tribe-add-exclusion"),this.$exclusion_rules=r(".tribe-event-recurrence-exclusion"),this.recurrence_errors={days:[],end:[]},window.Handlebars.registerHelper({tribe_recurrence_select:function(e,t){var n=r("<select />").html(t.fn(this));return e&&n.find("option:selected").attr("selected",!1),n.find('[value="'+e+'"]').attr("selected","selected"),n.html()},tribe_checked_if_is:function(e,r){return e===r?"checked":""},tribe_checked_if_is_not:function(e,r){return e!==r?"checked":""},tribe_checked_if_in:function(e,t){return-1!==r.inArray(e,t)?"checked":""}}),this.populate_recurrence(tribe_events_pro_recurrence_data),r(".eventForm").on("submit",".wp-admin.events-cal #post",this.event.submit_validation).on("change",'[data-field="type"]',this.event.recurrence_type_changed).on("change",'[data-field="end-type"]',this.event.recurrence_end_type_changed).on("change",'[data-field="custom-type"]',this.event.recurrence_custom_type_changed).on("change",'[data-field="custom-month-number"]',this.event.recurrence_custom_month_changed).on("change",".recurrence_end_count",this.event.recurrence_end_count_changed).on("change",".recurrence-row, .custom-recurrence-row",this.event.recurrence_row_changed).on("change",".tribe-custom-same-time input",this.event.same_time_changed).on("change",'#EventStartDate, #EventEndDate, select[name="EventStartHour"], select[name="EventStartMinute"], select[name="EventStartMeridian"], select[name="EventEndHour"], select[name="EventEndMinute"], select[name="EventEndMeridian"]',this.event.datepicker_updated).on("click","#tribe-add-recurrence",this.event.add_recurrence).on("click","#tribe-add-exclusion",this.event.add_exclusion).on("click",".tribe-event-recurrence .tribe-handle",this.event.toggle_rule),r('input[data-field="is_recurring"][value="true"]').length&&(r(".eventForm").on("change",".recurrence-row input, .custom-recurrence-row input, .recurrence-row select, .custom-recurrence-row select",this.event.recurrence_changed),r(".eventForm").on("recurrenceEndChanged",'[data-field="end"]',this.event.recurrence_changed)),r('[data-field="end"]').datepicker("option","onSelect",this.event.datepicker_end_date_changed),r(".recurrence_end, #EventStartDate, #EventEndDate").datepicker("option","onClose",this.event.datepicker_updated),this.set_recurrence_end_min_date(),r(".eventForm").find('[data-field="type"]').trigger("change"))},t.add_recurrence=function(e){if("undefined"!=typeof e&&"undefined"!=typeof e.end&&e.end){var n=tribe_datepicker_opts.dateFormat.toUpperCase().replace("YY","YYYY");e.end=moment(e.end).format(n)}this.$recurrence_staging.append(this.recurrence_template(e));var a=this.$recurrence_staging.find(".tribe-event-recurrence");a.find('[name*="recurrence[rules][]"]').each(function(){var e=r(this);e.attr("name",e.attr("name").replace(/recurrence\[rules\]\[\]/,"recurrence[rules]["+t.recurrence_count+"]"))}),e||a.find(".tribe-same-time-checkbox").prop("checked",!0),a.find(".tribe-datepicker").datepicker(tribe_datepicker_opts),a.insertBefore(this.$recurrence_staging),this.set_recurrence_data_attributes(a),this.adjust_rule_helper_text(a),this.update_rule_recurrence_text(a),this.$recurrence_rules=this.$recurrence_rules.add(a),this.recurrence_count++,this.check_for_useful_rule()},t.check_for_useful_rule=function(){var e=this.$recurrence_rules.filter(":first"),t=!1;this.$recurrence_rules.find('[data-field="type"] option:selected').each(function(){var e=r(this);"None"!==e.val()&&(t=!0)}),t?e.closest("table").addClass("tribe-has-recurrence-rule"):e.closest("table").removeClass("tribe-has-recurrence-rule")},t.add_exclusion=function(e){this.$exclusion_staging.append(this.exclusion_template(e));var n=this.$exclusion_staging.find(".tribe-event-recurrence");n.find('[name*="recurrence[exclusions][]"]').each(function(){var e=r(this);e.attr("name",e.attr("name").replace(/recurrence\[exclusions\]\[\]/,"recurrence[exclusions]["+t.exclusion_count+"]"))}),n.find(".tribe-datepicker").datepicker(tribe_datepicker_opts),n.insertBefore(this.$exclusion_staging),this.set_recurrence_data_attributes(n),this.adjust_rule_helper_text(n),this.$exclusion_rules=this.$exclusion_rules.add(n),this.exclusion_count++},t.populate_recurrence=function(e){var r=0;if("undefined"==typeof e.rules||!e.rules.length)return void this.add_recurrence();for(r in e.rules)this.add_recurrence(e.rules[r]);if("undefined"!=typeof e.exclusions&&e.exclusions.length)for(r in e.exclusions)this.add_exclusion(e.exclusions[r])},t.adjust_rule_helper_text=function(e){var r=e.find('[data-field="custom-type"] option:selected');e.find(".recurrence-interval-type").text(r.data("plural")),e.find('[data-field="custom-type-text"]').val(r.data("plural"))},t.set_recurrence_data_attributes=function(e){var t=e||this.$recurrence_rules;t.each(function(){var e=r(this),t=null,n=["is_recurring","type","end-type","custom-type","custom-month-number"];for(var a in n)t=e.find('[data-field="'+n[a]+'"]'),"custom-month-number"===n[a]?e.attr("data-recurrence-"+n[a],isNaN(t.val())?"string":"numeric"):"custom-month-number"===n[a]?e.attr("data-recurrence-"+n[a],t.is(":checked")?"yes":"no"):e.attr("data-recurrence-"+n[a],t.val());var c=e.find('[data-field="custom-type"]'),s=null;switch(c.val()){case"Weekly":s="week";break;case"Monthly":s="month";break;case"Yearly":s="year";break;case"Daily":default:s="day"}var i=e.find('[data-field="custom-'+s+'-same-time"]');e.attr("data-recurrence-same-time",i.filter(":checked").length?"yes":"no")})},t.set_recurrence_end_min_date=function(){var e=r("#EventStartDate").val();""!==e&&r(".recurrence_end").attr("placeholder",e).datepicker("option","minDate",e)},t.has_valid_recurrence_days=function(){var e=!0;return this.$recurrence_rules.each(function(n){t.has_valid_recurrence_days_for_rule(r(this))||(e=!1,t.recurrence_errors.days.push(n))}),e},t.has_valid_recurrence_days_for_rule=function(e){var r=e.find('[data-field="custom-interval"]'),t=e.find('[data-field="type"] option:selected');return r.val()===parseInt(r.val(),10)||"Custom"!==t.val()},t.has_valid_recurrence_ends=function(){var e=!0;return this.$recurrence_rules.each(function(n){t.has_valid_recurrence_end_for_rule(r(this))||(e=!1,t.recurrence_errors.end.push(n))}),e},t.has_valid_recurrence_end_for_rule=function(e){var r=e.find('[data-field="end"]'),t=e.find('[data-field="end-type"]'),n=e.find('[data-field="type"]');return"None"!==n.val()&&"On"===t.val()?r.val()&&!r.hasClass("placeholder"):!0},t.reset_submit_button=function(){r("#publishing-action .button-primary-disabled").removeClass("button-primary-disabled"),r("#publishing-action .spinner").hide()},t.validate_recurrence=function(){var e=!0;return this.has_valid_recurrence_days()||(e=!1,alert(r(".rec-days-error:first").text()),r(".rec-days-error").each(function(e){r.inArray(e,t.recurrence_errors.days)&&r(this).show()})),this.has_valid_recurrence_ends()||(e=!1,alert(r(".rec-end-error:first").text()),r(".rec-end-error").each(function(e){r.inArray(e,t.recurrence_errors.end)&&r(this).show()})),e},t.toggle_rule=function(e,r){"undefined"!==r&&r?"open"===r?e.addClass("tribe-open"):e.removeClass("tribe-open"):e.toggleClass("tribe-open")},t.update_recurrence_text=function(){this.$recurrence_rules.each(function(){t.update_rule_recurrence_text(r(this))})},t.update_rule_recurrence_text=function(e){var t=e.find('[data-field="type"] option:selected').val(),n=e.find('[data-field="end-type"] option:selected').val(),a=e.find('[data-field="end"]').val(),c=e.find('[data-field="end-count"]').val(),s=e.find('[data-field="custom-type"] option:selected').val(),i=!!e.find(".tribe-same-time-checkbox:checked").length,l=e.find('[data-field="custom-interval"]').val(),d=!!e.find('[data-field="custom-year-filter"]:checked').length;a||(a=e.find('[data-field="end"]').attr("placeholder")),t=t.toLowerCase().replace(" ","-"),n=n.toLowerCase().replace(" ","-"),s=s.toLowerCase().replace(" ","-"),"none"===t&&e.find(".tribe-event-recurrence-description").html("");var u=tribe_datepicker_opts.dateFormat.toUpperCase();u=u.replace("YY","YYYY");var o=e.closest(".eventForm");u+=o.find('[name="EventStartMeridian"]').length?" hh:mm a":" HH:mm";var _=r(document.getElementById("EventStartDate")),p=_.val(),m=o.find('[name="EventStartMeridian"] option:selected');p+=" "+o.find('[name="EventStartHour"] option:selected').val()+":"+o.find('[name="EventStartMinute"] option:selected').val(),m.length&&(p+=" "+m.val().toUpperCase());var f=r(document.getElementById("EventEndDate")),h=f.val(),v=o.find('[name="EventEndMeridian"] option:selected');h+=" "+o.find('[name="EventEndHour"] option:selected').val()+":"+o.find('[name="EventEndMinute"] option:selected').val(),v.length&&(h+=" "+v.val().toUpperCase());var y=moment(p,u),b=moment(h,u),$=b.diff(y,"days"),g=Math.ceil(100*(b.diff(y,"hours",!0)-24*$))/100,k=e.find('[data-field="custom-start-time-hour"] option:selected').val()+":"+e.find('[data-field="custom-start-time-minute"] option:selected').val(),x=e.find('[data-field="custom-start-time-meridian"] option:selected');x.length&&(k+=" "+x.val());var w=y.format("YYYY-MM-DD")+" "+k,E=parseInt(e.find('[data-field="custom-duration-days"]').val(),10),C=parseInt(e.find('[data-field="custom-duration-hours"]').val(),10),N=parseInt(e.find('[data-field="custom-duration-minutes"]').val(),10),Y=moment(w,u),D=Y.add({days:E,hours:C,minutes:N}),M=D.diff(Y,"days"),j=Math.ceil(100*(D.diff(Y,"hours",!0)-24*$))/100;if(!i){var E=parseInt(e.find('[data-field="custom-duration-days"]').val(),10),C=parseFloat(e.find('[data-field="custom-duration-hours"]').val()),I=parseInt(e.find('[data-field="custom-duration-minutes"]').val(),10);E=isNaN(E)?0:E,C=isNaN(C)?0:C,I=isNaN(I)?0:I,M=E,j=C+I/60,j=Math.ceil(100*j)/100}var S=[],H=[],F=null,B=null,L=null;"weekly"===s&&(e.find('[data-field="custom-week-day"]:checked').each(function(){S.push(tribe_events_pro_recurrence_strings.date.weekdays[parseInt(r(this).val(),10)-1])}),0===S.length?S=tribe_events_pro_recurrence_strings.date.day_placeholder:2===S.length?S=S.join(" "+tribe_events_pro_recurrence_strings.date.collection_joiner+" "):(S=S.join(", "),S=S.replace(/(.*),/,"$1, "+tribe_events_pro_recurrence_strings.date.collection_joiner))),"monthly"===s&&(F=e.find('[data-field="custom-month-number"] option:selected').val(),B=e.find('[data-field="custom-month-day"] option:selected').val()),"yearly"===s&&(F=e.find('[data-field="custom-year-month-number"] option:selected').val(),B=e.find('[data-field="custom-year-month-day"] option:selected').val(),e.find('[data-field="custom-year-month"]:checked').each(function(){H.push(tribe_events_pro_recurrence_strings.date.months[parseInt(r(this).val(),10)-1])}),0===H.length?H=tribe_events_pro_recurrence_strings.date.month_placeholder:2===H.length?H=H.join(" "+tribe_events_pro_recurrence_strings.date.collection_joiner+" "):(H=H.join(", "),H=H.replace(/(.*),/,"$1, "+tribe_events_pro_recurrence_strings.date.collection_joiner)));var U=t;"custom"===t?(U+="-"+s+"-"+n+"-"+(i?"same":"diff")+"-time","monthly"!==s||isNaN(F)||(U+="-numeric"),"yearly"!==s||d||(U+="-unfiltered")):(U="simple-"+U,U+="-"+n),"weekly"===s&&0===S.length?U="every-week-on":"monthly"!==s||F||B?"yearly"!==s||F||B||(U="every-year-on"):U="every-month-on";var A=tribe_events_pro_recurrence_strings.recurrence[U];if(F&&B)if(isNaN(F)||"yearly"===s&&d){if("yearly"===s)switch(F){case"1":F="first";break;case"2":F="second";break;case"3":F="third";break;case"4":F="fourth";break;case"5":F="fifth";break;case"-1":F="last"}L=tribe_events_pro_recurrence_strings.date[F.toLowerCase()+"_x"],L=!isNaN(B)&&B>0?L.replace("%1$s",tribe_events_pro_recurrence_strings.date.weekdays[parseInt(B,10)-1]):isNaN(B)?L.replace("%1$s",tribe_events_pro_recurrence_strings.date.day_placeholder):L.replace("%1$s",tribe_events_pro_recurrence_strings.date.day)}else L="yearly"!==s||d?F:y.format("D");else L=tribe_events_pro_recurrence_strings.date.day_placeholder;switch(U){case"simple-date-on":A=A.replace("%1$s",a);break;case"simple-every-day-on":case"simple-every-week-on":case"simple-every-month-on":case"simple-every-year-on":A=A.replace("%1$s",a);break;case"every-day-on":case"every-week-on":case"every-month-on":case"every-year-on":case"every-day-never":case"every-week-never":case"every-month-never":case"every-year-never":A=A.replace("%1$s",$),A=A.replace("%2$s",g),A=A.replace("%3$s",a);break;case"every-day-after":case"every-week-after":case"every-month-after":case"every-year-after":A=A.replace("%1$s",$),A=A.replace("%2$s",g),A=A.replace("%3$s",c);break;case"custom-daily-on-same-time":case"custom-daily-never-same-time":A=A.replace("%1$s",l),A=A.replace("%2$s",$),A=A.replace("%3$s",g),A=A.replace("%4$s",a);break;case"custom-daily-after-same-time":A=A.replace("%1$s",l),A=A.replace("%2$s",$),A=A.replace("%3$s",g),A=A.replace("%4$s",c);break;case"custom-daily-on-diff-time":case"custom-daily-never-diff-time":A=A.replace("%1$s",l),A=A.replace("%2$s",k),A=A.replace("%3$s",M),A=A.replace("%4$s",j),A=A.replace("%5$s",a);break;case"custom-daily-after-diff-time":A=A.replace("%1$s",l),A=A.replace("%2$s",k),A=A.replace("%3$s",M),A=A.replace("%4$s",j),A=A.replace("%5$s",c);break;case"custom-weekly-on-same-time":case"custom-weekly-never-same-time":A=A.replace("%1$s",l),A=A.replace("%2$s",S),A=A.replace("%3$s",$),A=A.replace("%4$s",g),A=A.replace("%5$s",a);break;case"custom-weekly-after-same-time":A=A.replace("%1$s",l),A=A.replace("%2$s",S),A=A.replace("%3$s",$),A=A.replace("%4$s",g),A=A.replace("%5$s",c);break;case"custom-weekly-on-diff-time":case"custom-weekly-never-diff-time":A=A.replace("%1$s",l),A=A.replace("%2$s",S),A=A.replace("%3$s",k),A=A.replace("%4$s",M),A=A.replace("%5$s",j),A=A.replace("%6$s",a);break;case"custom-weekly-after-diff-time":A=A.replace("%1$s",l),A=A.replace("%2$s",S),A=A.replace("%3$s",k),A=A.replace("%4$s",M),A=A.replace("%5$s",j),A=A.replace("%6$s",c);break;case"custom-monthly-on-same-time-numeric":case"custom-monthly-never-same-time-numeric":case"custom-monthly-on-same-time":case"custom-monthly-never-same-time":A=A.replace("%1$s",l),A=A.replace("%2$s",L),A=A.replace("%3$s",$),A=A.replace("%4$s",g),A=A.replace("%5$s",a);break;case"custom-monthly-after-same-time-numeric":case"custom-monthly-after-same-time":A=A.replace("%1$s",l),A=A.replace("%2$s",L),A=A.replace("%3$s",$),A=A.replace("%4$s",g),A=A.replace("%5$s",c);break;case"custom-monthly-on-diff-time-numeric":case"custom-monthly-never-diff-time-numeric":case"custom-monthly-on-diff-time":case"custom-monthly-never-diff-time":A=A.replace("%1$s",l),A=A.replace("%2$s",L),A=A.replace("%3$s",k),A=A.replace("%4$s",M),A=A.replace("%5$s",j),A=A.replace("%6$s",a);break;case"custom-monthly-after-diff-time-numeric":case"custom-monthly-after-diff-time":A=A.replace("%1$s",l),A=A.replace("%2$s",L),A=A.replace("%3$s",k),A=A.replace("%4$s",M),A=A.replace("%5$s",j),A=A.replace("%6$s",c);break;case"custom-yearly-on-same-time-unfiltered":case"custom-yearly-never-same-time-unfiltered":case"custom-yearly-on-same-time":case"custom-yearly-never-same-time":A=A.replace("%1$s",l),A=A.replace("%2$s",H),A=A.replace("%3$s",L),A=A.replace("%4$s",$),A=A.replace("%5$s",g),A=A.replace("%6$s",a);break;case"custom-yearly-after-same-time-unfiltered":case"custom-yearly-after-same-time":A=A.replace("%1$s",l),A=A.replace("%2$s",H),A=A.replace("%3$s",L),A=A.replace("%4$s",$),A=A.replace("%5$s",g),A=A.replace("%6$s",c);break;case"custom-yearly-on-diff-time-unfiltered":case"custom-yearly-never-diff-time-unfiltered":case"custom-yearly-on-diff-time":case"custom-yearly-never-diff-time":A=A.replace("%1$s",l),A=A.replace("%2$s",H),A=A.replace("%3$s",L),A=A.replace("%4$s",k),A=A.replace("%5$s",M),A=A.replace("%6$s",j),A=A.replace("%7$s",a);break;case"custom-yearly-after-diff-time-unfiltered":case"custom-yearly-after-diff-time":A=A.replace("%1$s",l),A=A.replace("%2$s",H),A=A.replace("%3$s",L),A=A.replace("%4$s",k),A=A.replace("%5$s",M),A=A.replace("%6$s",j),A=A.replace("%7$s",c)}e.find(".tribe-event-recurrence-description").html(A)},t.event.add_recurrence=function(e){e.preventDefault(),t.add_recurrence()},t.event.add_exclusion=function(e){e.preventDefault(),t.add_exclusion()},t.event.recurrence_type_changed=function(){var e=r(this),n=e.closest(".tribe-event-recurrence");n.addClass("tribe-open");var a=e.find("option:selected").val();"Custom"===a&&n.find('[data-field="custom-type"]').change();var c=n.find(".occurence-count-text"),s=parseInt(n.find(".recurrence_end_count").val(),10),i=e.data("plural");1===s&&(i=e.data("single")),c.text(i),n.find('[data-field="occurrence-count-text"]').val(c.text()),t.set_recurrence_data_attributes(n),t.check_for_useful_rule()},t.event.recurrence_end_type_changed=function(){var e=r(this),n=e.closest(".tribe-event-recurrence");t.set_recurrence_data_attributes(n)},t.event.recurrence_custom_type_changed=function(){var e=r(this),n=e.closest(".tribe-event-recurrence");n.is(".tribe-event-recurrence-exclusion")&&n.addClass("tribe-open"),t.adjust_rule_helper_text(n),t.set_recurrence_data_attributes(n)},t.event.recurrence_changed=function(){var e=r(this),n=e.closest(".tribe-event-recurrence");n.attr("data-recurrence-changed","yes"),t.toggle_rule(n,"open")},t.event.recurrence_end_count_changed=function(){var e=r(this),t=e.closest(".tribe-event-recurrence");t.find('[data-field="type"]').change()},t.event.recurrence_custom_month_changed=function(){var e=r(this),n=e.closest(".tribe-event-recurrence");t.set_recurrence_data_attributes(n)},t.event.submit_validation=function(){return tribe_events_pro_admin.validate_recurrence()?void 0:(e.preventDefault(),e.stopPropagation(),tribe_events_pro_admin.reset_submit_button(),!1)},t.event.datepicker_updated=function(){tribe_events_pro_admin.recurrence.update_recurrence_text(),tribe_events_pro_admin.recurrence.set_recurrence_end_min_date()},t.event.datepicker_end_date_changed=function(){r(this).removeClass("placeholder"),r(this).trigger("recurrenceEndChanged"),r(this).trigger("recurrence-end-changed.tribe")},t.event.recurrence_row_changed=function(){var e=r(".recurrence-pattern-description-row");e.is(":visible")||e.show(),tribe_events_pro_admin.recurrence.update_recurrence_text()},t.event.same_time_changed=function(){if("undefined"==typeof t.updating_same_time_checked||!0!==t.updating_same_time_checked){var e=r(this),n=e.closest(".tribe-event-recurrence");t.updating_same_time_checked=!0,e.filter(":checked").length?n.find(".tribe-custom-same-time input").prop("checked",!0):n.find(".tribe-custom-same-time input").prop("checked",!1),t.updating_same_time_checked=!1,t.set_recurrence_data_attributes(n)}},t.event.toggle_rule=function(){var e=r(this);t.toggle_rule(e.closest(".tribe-event-recurrence"))},r(function(){t.init()})}(jQuery,tribe_events_pro_admin.recurrence);