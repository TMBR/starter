var tribe_events_pro_admin=tribe_events_pro_admin||{};tribe_events_pro_admin.recurrence={recurrence_count:0,exclusion_count:0,event:{}},function(a,b){"use strict";b.init=function(){this.init_recurrence()},b.init_recurrence=function(){this.$recurrence_staging=a("#tribe-recurrence-staging"),this.$recurrence_tmpl=a("#tmpl-tribe-recurrence"),this.$recurrence_tmpl.length&&(this.recurrence_template=Handlebars.compile(this.$recurrence_tmpl.html()),this.$add_recurrence=a("#tribe-add-recurrence"),this.$recurrence_rules=a(".tribe-event-recurrence-rule"),this.$exclusion_staging=a("#tribe-exclusion-staging"),this.$exclusion_tmpl=a("#tmpl-tribe-exclusion"),this.exclusion_template=Handlebars.compile(this.$exclusion_tmpl.html()),this.$add_exclusion=a("#tribe-add-exclusion"),this.$exclusion_rules=a(".tribe-event-recurrence-exclusion"),this.recurrence_errors={days:[],end:[]},window.Handlebars.registerHelper({tribe_recurrence_select:function(b,c){var d=a("<select />").html(c.fn(this));return b&&d.find("option:selected").attr("selected",!1),d.find('[value="'+b+'"]').attr("selected","selected"),d.html()},tribe_checked_if_is:function(a,b){return a===b?"checked":""},tribe_checked_if_is_not:function(a,b){return a!==b?"checked":""},tribe_checked_if_in:function(b,c){return-1!==a.inArray(b,c)?"checked":""}}),this.populate_recurrence(tribe_events_pro_recurrence_data),a(".eventForm").on("submit",".wp-admin.events-cal #post",this.event.submit_validation).on("change",'[data-field="type"]',this.event.recurrence_type_changed).on("change",'[data-field="end-type"]',this.event.recurrence_end_type_changed).on("change",'[data-field="custom-type"]',this.event.recurrence_custom_type_changed).on("change",'[data-field="custom-month-number"]',this.event.recurrence_custom_month_changed).on("change",".recurrence_end_count",this.event.recurrence_end_count_changed).on("change",".recurrence-row, .custom-recurrence-row",this.event.recurrence_row_changed).on("change",".tribe-custom-same-time input",this.event.same_time_changed).on("change",'#EventStartDate, #EventEndDate, select[name="EventStartHour"], select[name="EventStartMinute"], select[name="EventStartMeridian"], select[name="EventEndHour"], select[name="EventEndMinute"], select[name="EventEndMeridian"]',this.event.datepicker_updated).on("click","#tribe-add-recurrence",this.event.add_recurrence).on("click","#tribe-add-exclusion",this.event.add_exclusion).on("click",".tribe-event-recurrence .tribe-handle",this.event.toggle_rule),a('input[data-field="is_recurring"][value="true"]').length&&(a(".eventForm").on("change",".recurrence-row input, .custom-recurrence-row input, .recurrence-row select, .custom-recurrence-row select",this.event.recurrence_changed),a(".eventForm").on("recurrenceEndChanged",'[data-field="end"]',this.event.recurrence_changed)),a('[data-field="end"]').datepicker("option","onSelect",this.event.datepicker_end_date_changed),a(".recurrence_end, #EventStartDate, #EventEndDate").datepicker("option","onClose",this.event.datepicker_updated),this.set_recurrence_end_min_date())},b.add_recurrence=function(c){if("undefined"!=typeof c&&"undefined"!=typeof c.end&&c.end){var d=tribe_datepicker_opts.dateFormat.toUpperCase().replace("YY","YYYY");c.end=moment(c.end).format(d)}this.$recurrence_staging.append(this.recurrence_template(c));var e=this.$recurrence_staging.find(".tribe-event-recurrence");e.find('[name*="recurrence[rules][]"]').each(function(){var c=a(this);c.attr("name",c.attr("name").replace(/recurrence\[rules\]\[\]/,"recurrence[rules]["+b.recurrence_count+"]"))}),c||e.find(".tribe-same-time-checkbox").prop("checked",!0),e.find(".tribe-datepicker").datepicker(tribe_datepicker_opts),e.insertBefore(this.$recurrence_staging),this.set_recurrence_data_attributes(e),this.adjust_rule_helper_text(e),this.update_rule_recurrence_text(e),this.$recurrence_rules=this.$recurrence_rules.add(e),this.recurrence_count++,this.check_for_useful_rule()},b.check_for_useful_rule=function(){var b=this.$recurrence_rules.filter(":first"),c=!1;this.$recurrence_rules.find('[data-field="type"] option:selected').each(function(){var b=a(this);"None"!==b.val()&&(c=!0)}),c?b.closest("table").addClass("tribe-has-recurrence-rule"):b.closest("table").removeClass("tribe-has-recurrence-rule")},b.add_exclusion=function(c){this.$exclusion_staging.append(this.exclusion_template(c));var d=this.$exclusion_staging.find(".tribe-event-recurrence");d.find('[name*="recurrence[exclusions][]"]').each(function(){var c=a(this);c.attr("name",c.attr("name").replace(/recurrence\[exclusions\]\[\]/,"recurrence[exclusions]["+b.exclusion_count+"]"))}),d.find(".tribe-datepicker").datepicker(tribe_datepicker_opts),d.insertBefore(this.$exclusion_staging),this.set_recurrence_data_attributes(d),this.adjust_rule_helper_text(d),this.$exclusion_rules=this.$exclusion_rules.add(d),this.exclusion_count++},b.populate_recurrence=function(a){var b=0;if("undefined"==typeof a.rules||!a.rules.length)return void this.add_recurrence();for(b in a.rules)this.add_recurrence(a.rules[b]);if("undefined"!=typeof a.exclusions&&a.exclusions.length)for(b in a.exclusions)this.add_exclusion(a.exclusions[b])},b.adjust_rule_helper_text=function(a){var b=a.find('[data-field="custom-type"] option:selected');a.find(".recurrence-interval-type").text(b.data("plural")),a.find('[data-field="custom-type-text"]').val(b.data("plural"))},b.set_recurrence_data_attributes=function(b){var c=b||this.$recurrence_rules;c.each(function(){var b=a(this),c=null,d=["is_recurring","type","end-type","custom-type","custom-month-number"];for(var e in d)c=b.find('[data-field="'+d[e]+'"]'),"custom-month-number"===d[e]?b.attr("data-recurrence-"+d[e],isNaN(c.val())?"string":"numeric"):"custom-month-number"===d[e]?b.attr("data-recurrence-"+d[e],c.is(":checked")?"yes":"no"):b.attr("data-recurrence-"+d[e],c.val());var f=b.find('[data-field="custom-type"]'),g=null;switch(f.val()){case"Weekly":g="week";break;case"Monthly":g="month";break;case"Yearly":g="year";break;case"Daily":default:g="day"}var h=b.find('[data-field="custom-'+g+'-same-time"]');b.attr("data-recurrence-same-time",h.filter(":checked").length?"yes":"no")})},b.set_recurrence_end_min_date=function(){var b=a("#EventStartDate").val();""!==b&&a(".recurrence_end").attr("placeholder",b).datepicker("option","minDate",b)},b.has_valid_recurrence_days=function(){var c=!0;return this.$recurrence_rules.each(function(d){b.has_valid_recurrence_days_for_rule(a(this))||(c=!1,b.recurrence_errors.days.push(d))}),c},b.has_valid_recurrence_days_for_rule=function(a){var b=a.find('[data-field="custom-interval"]'),c=a.find('[data-field="type"] option:selected');return b.val()!==parseInt(b.val(),10)&&"Custom"===c.val()?!1:!0},b.has_valid_recurrence_ends=function(){var c=!0;return this.$recurrence_rules.each(function(d){b.has_valid_recurrence_end_for_rule(a(this))||(c=!1,b.recurrence_errors.end.push(d))}),c},b.has_valid_recurrence_end_for_rule=function(a){var b=a.find('[data-field="end"]'),c=a.find('[data-field="end-type"]'),d=a.find('[data-field="type"]');return"None"!==d.val()&&"On"===c.val()?b.val()&&!b.hasClass("placeholder"):!0},b.reset_submit_button=function(){a("#publishing-action .button-primary-disabled").removeClass("button-primary-disabled"),a("#publishing-action .spinner").hide()},b.validate_recurrence=function(){var c=!0;return this.has_valid_recurrence_days()||(c=!1,alert(a(".rec-days-error:first").text()),a(".rec-days-error").each(function(c){a.inArray(c,b.recurrence_errors.days)&&a(this).show()})),this.has_valid_recurrence_ends()||(c=!1,alert(a(".rec-end-error:first").text()),a(".rec-end-error").each(function(c){a.inArray(c,b.recurrence_errors.end)&&a(this).show()})),c},b.toggle_rule=function(a,b){"undefined"!==b&&b?"open"===b?a.addClass("tribe-open"):a.removeClass("tribe-open"):a.toggleClass("tribe-open")},b.update_recurrence_text=function(){this.$recurrence_rules.each(function(){b.update_rule_recurrence_text(a(this))})},b.update_rule_recurrence_text=function(b){var c=b.find('[data-field="type"] option:selected').val(),d=b.find('[data-field="end-type"] option:selected').val(),e=b.find('[data-field="end"]').val(),f=b.find('[data-field="end-count"]').val(),g=b.find('[data-field="custom-type"] option:selected').val(),h=b.find(".tribe-same-time-checkbox:checked").length?!0:!1,i=b.find('[data-field="custom-interval"]').val(),j=b.find('[data-field="custom-year-filter"]:checked').length?!0:!1;e||(e=b.find('[data-field="end"]').attr("placeholder")),c=c.toLowerCase().replace(" ","-"),d=d.toLowerCase().replace(" ","-"),g=g.toLowerCase().replace(" ","-"),"none"===c&&b.find(".tribe-event-recurrence-description").html("");var k=tribe_datepicker_opts.dateFormat.toUpperCase();k=k.replace("YY","YYYY");var l=b.closest(".eventForm");k+=l.find('[name="EventStartMeridian"]').length?" hh:mm a":" HH:mm";var m=a(document.getElementById("EventStartDate")),n=m.val(),o=l.find('[name="EventStartMeridian"] option:selected');n+=" "+l.find('[name="EventStartHour"] option:selected').val()+":"+l.find('[name="EventStartMinute"] option:selected').val(),o.length&&(n+=" "+o.val().toUpperCase());var p=a(document.getElementById("EventEndDate")),q=p.val(),r=l.find('[name="EventEndMeridian"] option:selected');q+=" "+l.find('[name="EventEndHour"] option:selected').val()+":"+l.find('[name="EventEndMinute"] option:selected').val(),r.length&&(q+=" "+r.val().toUpperCase());var s=moment(n,k),t=moment(q,k),u=t.diff(s,"days"),v=Math.ceil(100*(t.diff(s,"hours",!0)-24*u))/100,w=b.find('[data-field="custom-start-time-hour"] option:selected').val()+":"+b.find('[data-field="custom-start-time-minute"] option:selected').val(),x=b.find('[data-field="custom-start-time-meridian"] option:selected');x.length&&(w+=" "+x.val());var y=s.format("YYYY-MM-DD")+" "+w,z=parseInt(b.find('[data-field="custom-duration-days"]').val(),10),A=parseInt(b.find('[data-field="custom-duration-hours"]').val(),10),B=parseInt(b.find('[data-field="custom-duration-minutes"]').val(),10),C=moment(y,k),D=C.add({days:z,hours:A,minutes:B}),E=D.diff(C,"days"),F=Math.ceil(100*(D.diff(C,"hours",!0)-24*u))/100;if(!h){var z=parseInt(b.find('[data-field="custom-duration-days"]').val(),10),A=parseFloat(b.find('[data-field="custom-duration-hours"]').val()),G=parseInt(b.find('[data-field="custom-duration-minutes"]').val(),10);z=isNaN(z)?0:z,A=isNaN(A)?0:A,G=isNaN(G)?0:G,E=z,F=A+G/60,F=Math.ceil(100*F)/100}var H=[],I=[],J=null,K=null,L=null;"weekly"===g&&(b.find('[data-field="custom-week-day"]:checked').each(function(){H.push(tribe_events_pro_recurrence_strings.date.weekdays[parseInt(a(this).val(),10)-1])}),0===H.length?H=tribe_events_pro_recurrence_strings.date.day_placeholder:2===H.length?H=H.join(" "+tribe_events_pro_recurrence_strings.date.collection_joiner+" "):(H=H.join(", "),H=H.replace(/(.*),/,"$1, "+tribe_events_pro_recurrence_strings.date.collection_joiner))),"monthly"===g&&(J=b.find('[data-field="custom-month-number"] option:selected').val(),K=b.find('[data-field="custom-month-day"] option:selected').val()),"yearly"===g&&(J=b.find('[data-field="custom-year-month-number"] option:selected').val(),K=b.find('[data-field="custom-year-month-day"] option:selected').val(),b.find('[data-field="custom-year-month"]:checked').each(function(){I.push(tribe_events_pro_recurrence_strings.date.months[parseInt(a(this).val(),10)-1])}),0===I.length?I=tribe_events_pro_recurrence_strings.date.month_placeholder:2===I.length?I=I.join(" "+tribe_events_pro_recurrence_strings.date.collection_joiner+" "):(I=I.join(", "),I=I.replace(/(.*),/,"$1, "+tribe_events_pro_recurrence_strings.date.collection_joiner)));var M=c;"custom"===c?(M+="-"+g+"-"+d+"-"+(h?"same":"diff")+"-time","monthly"!==g||isNaN(J)||(M+="-numeric"),"yearly"!==g||j||(M+="-unfiltered")):(M="simple-"+M,M+="-"+d),"weekly"===g&&0===H.length?M="every-week-on":"monthly"!==g||J||K?"yearly"!==g||J||K||(M="every-year-on"):M="every-month-on";var N=tribe_events_pro_recurrence_strings.recurrence[M];if(J&&K)if(isNaN(J)||"yearly"===g&&j){if("yearly"===g)switch(J){case"1":J="first";break;case"2":J="second";break;case"3":J="third";break;case"4":J="fourth";break;case"5":J="fifth";break;case"-1":J="last"}L=tribe_events_pro_recurrence_strings.date[J.toLowerCase()+"_x"],L=!isNaN(K)&&K>0?L.replace("%1$s",tribe_events_pro_recurrence_strings.date.weekdays[parseInt(K,10)-1]):isNaN(K)?L.replace("%1$s",tribe_events_pro_recurrence_strings.date.day_placeholder):L.replace("%1$s",tribe_events_pro_recurrence_strings.date.day)}else L="yearly"!==g||j?J:s.format("D");else L=tribe_events_pro_recurrence_strings.date.day_placeholder;switch(M){case"simple-every-day-on":case"simple-every-week-on":case"simple-every-month-on":case"simple-every-year-on":N=N.replace("%1$s",e);break;case"every-day-on":case"every-week-on":case"every-month-on":case"every-year-on":case"every-day-never":case"every-week-never":case"every-month-never":case"every-year-never":N=N.replace("%1$s",u),N=N.replace("%2$s",v),N=N.replace("%3$s",e);break;case"every-day-after":case"every-week-after":case"every-month-after":case"every-year-after":N=N.replace("%1$s",u),N=N.replace("%2$s",v),N=N.replace("%3$s",f);break;case"custom-daily-on-same-time":case"custom-daily-never-same-time":N=N.replace("%1$s",i),N=N.replace("%2$s",u),N=N.replace("%3$s",v),N=N.replace("%4$s",e);break;case"custom-daily-after-same-time":N=N.replace("%1$s",i),N=N.replace("%2$s",u),N=N.replace("%3$s",v),N=N.replace("%4$s",f);break;case"custom-daily-on-diff-time":case"custom-daily-never-diff-time":N=N.replace("%1$s",i),N=N.replace("%2$s",w),N=N.replace("%3$s",E),N=N.replace("%4$s",F),N=N.replace("%5$s",e);break;case"custom-daily-after-diff-time":N=N.replace("%1$s",i),N=N.replace("%2$s",w),N=N.replace("%3$s",E),N=N.replace("%4$s",F),N=N.replace("%5$s",f);break;case"custom-weekly-on-same-time":case"custom-weekly-never-same-time":N=N.replace("%1$s",i),N=N.replace("%2$s",H),N=N.replace("%3$s",u),N=N.replace("%4$s",v),N=N.replace("%5$s",e);break;case"custom-weekly-after-same-time":N=N.replace("%1$s",i),N=N.replace("%2$s",H),N=N.replace("%3$s",u),N=N.replace("%4$s",v),N=N.replace("%5$s",f);break;case"custom-weekly-on-diff-time":case"custom-weekly-never-diff-time":N=N.replace("%1$s",i),N=N.replace("%2$s",H),N=N.replace("%3$s",w),N=N.replace("%4$s",E),N=N.replace("%5$s",F),N=N.replace("%6$s",e);break;case"custom-weekly-after-diff-time":N=N.replace("%1$s",i),N=N.replace("%2$s",H),N=N.replace("%3$s",w),N=N.replace("%4$s",E),N=N.replace("%5$s",F),N=N.replace("%6$s",f);break;case"custom-monthly-on-same-time-numeric":case"custom-monthly-never-same-time-numeric":case"custom-monthly-on-same-time":case"custom-monthly-never-same-time":N=N.replace("%1$s",i),N=N.replace("%2$s",L),N=N.replace("%3$s",u),N=N.replace("%4$s",v),N=N.replace("%5$s",e);break;case"custom-monthly-after-same-time-numeric":case"custom-monthly-after-same-time":N=N.replace("%1$s",i),N=N.replace("%2$s",L),N=N.replace("%3$s",u),N=N.replace("%4$s",v),N=N.replace("%5$s",f);break;case"custom-monthly-on-diff-time-numeric":case"custom-monthly-never-diff-time-numeric":case"custom-monthly-on-diff-time":case"custom-monthly-never-diff-time":N=N.replace("%1$s",i),N=N.replace("%2$s",L),N=N.replace("%3$s",w),N=N.replace("%4$s",E),N=N.replace("%5$s",F),N=N.replace("%6$s",e);break;case"custom-monthly-after-diff-time-numeric":case"custom-monthly-after-diff-time":N=N.replace("%1$s",i),N=N.replace("%2$s",L),N=N.replace("%3$s",w),N=N.replace("%4$s",E),N=N.replace("%5$s",F),N=N.replace("%6$s",f);break;case"custom-yearly-on-same-time-unfiltered":case"custom-yearly-never-same-time-unfiltered":case"custom-yearly-on-same-time":case"custom-yearly-never-same-time":N=N.replace("%1$s",i),N=N.replace("%2$s",I),N=N.replace("%3$s",L),N=N.replace("%4$s",u),N=N.replace("%5$s",v),N=N.replace("%6$s",e);break;case"custom-yearly-after-same-time-unfiltered":case"custom-yearly-after-same-time":N=N.replace("%1$s",i),N=N.replace("%2$s",I),N=N.replace("%3$s",L),N=N.replace("%4$s",u),N=N.replace("%5$s",v),N=N.replace("%6$s",f);break;case"custom-yearly-on-diff-time-unfiltered":case"custom-yearly-never-diff-time-unfiltered":case"custom-yearly-on-diff-time":case"custom-yearly-never-diff-time":N=N.replace("%1$s",i),N=N.replace("%2$s",I),N=N.replace("%3$s",L),N=N.replace("%4$s",w),N=N.replace("%5$s",E),N=N.replace("%6$s",F),N=N.replace("%7$s",e);break;case"custom-yearly-after-diff-time-unfiltered":case"custom-yearly-after-diff-time":N=N.replace("%1$s",i),N=N.replace("%2$s",I),N=N.replace("%3$s",L),N=N.replace("%4$s",w),N=N.replace("%5$s",E),N=N.replace("%6$s",F),N=N.replace("%7$s",f)}b.find(".tribe-event-recurrence-description").html(N)},b.event.add_recurrence=function(a){a.preventDefault(),b.add_recurrence()},b.event.add_exclusion=function(a){a.preventDefault(),b.add_exclusion()},b.event.recurrence_type_changed=function(){var c=a(this),d=c.closest(".tribe-event-recurrence");d.addClass("tribe-open");var e=c.find("option:selected").val();"Custom"===e&&d.find('[data-field="custom-type"]').change();var f=d.find(".occurence-count-text"),g=parseInt(d.find(".recurrence_end_count").val(),10),h=c.data("plural");1===g&&(h=c.data("single")),f.text(h),d.find('[data-field="occurrence-count-text"]').val(f.text()),b.set_recurrence_data_attributes(d),b.check_for_useful_rule()},b.event.recurrence_end_type_changed=function(){var c=a(this),d=c.closest(".tribe-event-recurrence");b.set_recurrence_data_attributes(d)},b.event.recurrence_custom_type_changed=function(){var c=a(this),d=c.closest(".tribe-event-recurrence");d.is(".tribe-event-recurrence-exclusion")&&d.addClass("tribe-open"),b.adjust_rule_helper_text(d),b.set_recurrence_data_attributes(d)},b.event.recurrence_changed=function(){var c=a(this),d=c.closest(".tribe-event-recurrence");d.attr("data-recurrence-changed","yes"),b.toggle_rule(d,"open")},b.event.recurrence_end_count_changed=function(){var b=a(this),c=b.closest(".tribe-event-recurrence");c.find('[data-field="type"]').change()},b.event.recurrence_custom_month_changed=function(){var c=a(this),d=c.closest(".tribe-event-recurrence");b.set_recurrence_data_attributes(d)},b.event.submit_validation=function(){tribe_events_pro_admin.validate_recurrence()||(e.preventDefault(),tribe_events_pro_admin.reset_submit_button())},b.event.datepicker_updated=function(){tribe_events_pro_admin.recurrence.update_recurrence_text(),tribe_events_pro_admin.recurrence.set_recurrence_end_min_date()},b.event.datepicker_end_date_changed=function(){a(this).removeClass("placeholder"),a(this).trigger("recurrenceEndChanged"),a(this).trigger("recurrence-end-changed.tribe")},b.event.recurrence_row_changed=function(){var b=a(".recurrence-pattern-description-row");b.is(":visible")||b.show(),tribe_events_pro_admin.recurrence.update_recurrence_text()},b.event.same_time_changed=function(){if("undefined"==typeof b.updating_same_time_checked||!0!==b.updating_same_time_checked){var c=a(this),d=c.closest(".tribe-event-recurrence");b.updating_same_time_checked=!0,c.filter(":checked").length?d.find(".tribe-custom-same-time input").prop("checked",!0):d.find(".tribe-custom-same-time input").prop("checked",!1),b.updating_same_time_checked=!1,b.set_recurrence_data_attributes(d)}},b.event.toggle_rule=function(){var c=a(this);b.toggle_rule(c.closest(".tribe-event-recurrence"))},a(function(){b.init()})}(jQuery,tribe_events_pro_admin.recurrence);